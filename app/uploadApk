#!/bin/sh

script_dir=$(cd $(dirname $0);pwd)
type=$1
echo "type: ${type}"
echo "ğŸ’ŠğŸ‘ŒğŸ’ğŸ‚ğŸ‘ğŸ¿ğŸŒ¹â¬†ï¸ãŠ™ï¸ğŸ±ğŸ©ğŸ‚ğŸ²âœˆï¸ğŸ‘€ğŸš€ğŸ”¥ğŸ®ğŸ’•ğŸ†ğŸ ğŸ’¯ ğŸŒ¹"

function upload(){
    apk_dir="${script_dir}/build/outputs/apk"
    universal_apk_dir="${apk_dir}/universal/$type"

    apk_path=$(find ${universal_apk_dir} -name "*.apk")
    apk_name=${apk_path##*/}
    version_name=$(echo $apk_name | sed 's/^v//;s/_.*//')
    version_code=$(grep VERSION_CODE version.properties | cut -d'=' -f2)
    echo "universal_apk_dir: ${universal_apk_dir}"
    echo "apk_name: ${apk_name}"
    echo "ç‰ˆæœ¬å·: ${version_name}(Build ${version_code})"

    # æœ¬åœ°æ–‡ä»¶è·¯å¾„
    # æµ‹è¯•åªéœ€ä¼ é€šç”¨åŒ…
    local_universal_file_path=$universal_apk_dir/$apk_name
    bucket_name="your_bucket_name/apks"
    # æ¸…ç©ºæ¡¶ rclone delete r2lz:bellybook2 --progress
    if [ "$type" = "release" ]; then
        # æ­£å¼ç¯å¢ƒä¸Šä¼ æµç¨‹
        endpoint="your_endpoint_url"
        remote_universal_file_path="$bucket_name/history/$apk_name"

        # 1. ä¸Šä¼ é€šç”¨åŒ…
        echo "ğŸš€ æ­£å¼ç¯å¢ƒæ­£åœ¨ä¸Šä¼  $local_universal_file_path \nè‡³ $remote_universal_file_path"
        rclone copyto ${local_universal_file_path}  ${remote_universal_file_path} --progress

        echo "ğŸš€ æŠŠåŒ…ä» history é‡Œ cp å‡ºæ¥"
        rclone copyto ${remote_universal_file_path} ${bucket_name}/fake_live.apk --progress
        # 2. ä¸Šä¼  google åŒ…å…ˆä¸ä¸Šä¼ 
#        local_google_file_path="$apk_dir/google/$type/$apk_name"
#        remote_google_file_path="$bucket_name/google/$apk_name"
#        echo "ğŸš€ ä¸Šä¼  google åŒ… ${local_google_file_path} è‡³ ${remote_google_file_path}"
#        rclone copyto ${local_google_file_path}  ${remote_google_file_path} --progress
        # 3. ä¸Šä¼  china åŒ…
        rclone delete $bucket_name/china
        local_china_file_path="$apk_dir/china/$type/$apk_name"
        remote_china_file_path="$bucket_name/china/$apk_name"
        echo "ğŸš€ ä¸Šä¼  china åŒ…é’ˆå¯¹ä¸­å›½é•œå†…åº”ç”¨å¸‚åœº ${local_china_file_path} è‡³ ${remote_china_file_path}"
        rclone copyto ${local_china_file_path}  ${remote_china_file_path} --progress
        # åˆ—å‡ºæ¡¶
        rclone ls $bucket_name
        echo "rclone copy $remote_china_file_path ~/Downloads/ --progress"
    else
        # æµ‹è¯•ç¯å¢ƒä¸Šä¼ æµç¨‹ å°±ä¸€ä¸ª apk
        remote_universal_file_path="$bucket_name/fake_live_test.apk"
        echo "ğŸš€ æµ‹è¯•ç¯å¢ƒæ­£åœ¨ä¸Šä¼  ${local_universal_file_path} \nè‡³ ${remote_universal_file_path}"
        rclone copyto ${local_universal_file_path}  ${remote_universal_file_path} --progress
      fi
}

function webhook() {
    if [ "$type" = "release" ]; then
        update_env="ç”Ÿäº§"
    else
        update_env="æµ‹è¯•"
    fi
    updatetime=`date +'%Y-%m-%d %H:%M:%S'`
    # æ›´æ–°å†…å®¹
    update_description="- å›å¿†æ¨¡å—é‡æ„\n- åˆ›å»ºäº‘æœµç²¾ç®€"
    curl -X POST -H "Content-Type: application/json" \
	-d '{
	"msg_type": "post",
	"content": {
		"post": {
			"zh_cn": {
				"title": "App æ›´æ–°é€šçŸ¥",
				"content": [
                    [{"tag": "text","text": "æ‚¨çš„åº”ç”¨ä¸Šä¼ äº†æ–°ç‰ˆæœ¬"}],
                    [{"tag": "text","text": "åº”ç”¨åç§°ï¼šé‚£æœµ('"${update_env}"')"}],
                    [{"tag": "text","text": "åº”ç”¨ç±»å‹ï¼šAndroid"}],
                    [{"tag": "text","text": "ç‰ˆæœ¬ä¿¡æ¯ï¼š'"${version_name}"'(Build '"${version_code}"')"}],
                    [{"tag": "text","text": "æ›´æ–°æ—¶é—´ï¼š'"${updatetime}"'"}],
                    [{"tag": "text","text": "æ›´æ–°å†…å®¹ï¼š'"${update_description}"'"}],
                    [{"tag": "text","text": "ç‰ˆæœ¬æŸ¥è¯¢ï¼š'"${baseUrl}"'/naduo/api/version/getVersion?platform=android"}],

					[
						{
							"tag": "a",
							"text": "ç‚¹é“¾æ¥æŸ¥çœ‹æ›´æ–°",
							"href": "https://naduo.love"
						},
						{
							"tag": "at",
							"user_id": "all",
                            "user_name": "æ‰€æœ‰äºº"
						}
				    ]
                ]
			}
		}
	}
    }' \
    https://open.feishu.cn/open-apis/bot/v2/hook/ef329f6f-c9c5-4d5
}

function start()
{
    starttime=`date +'%Y-%m-%d %H:%M:%S'`
    echo "ä¸Šä¼ å¼€å§‹æ—¶é—´ : " ${starttime}
    upload
    if [ "$type" = "release" ]; then
        echo "æ­£å¼ æ‰‹åŠ¨æ‰ç”¨å‘ç‰ˆæ¥å£"
    else
        echo "æµ‹è¯• è‡ªåŠ¨æ‰ç”¨å‘ç‰ˆæ¥å£"
#        webhook
    fi


    endtime=`date +'%Y-%m-%d %H:%M:%S'`
    echo "ç»“æŸæ—¶é—´ : " ${endtime}
    echo "æ‚¨æœ‰ä¸€ä¸ªæ–°çš„Appç‰ˆæœ¬ï¼Œè¯·åŠæ—¶æ›´æ–°ğŸ‘Œ ğŸ”¥ ğŸ‘Œ ğŸ”¥ ğŸ’¯ ğŸ”¥ ğŸ’¯ ğŸ”¥ ğŸ’¯ ğŸ”¥ ğŸ’¯ ğŸ‘Œ ğŸ”¥ ğŸ‘Œ ğŸ”¥ ğŸ’¯ ğŸ”¥ ğŸ’¯ ğŸ”¥ ğŸ’¯ ğŸ”¥ ğŸ’¯ ğŸ”¥ ğŸ’¯ ğŸ”¥ ğŸ’¯ ğŸ”¥"
}

start
# upload
